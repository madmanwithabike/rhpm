#!/bin/bash

set -eu
set -o pipefail

PRJ_PATH="`dirname \"${BASH_SOURCE[0]}\"`"
if [[ ! -d "$PRJ_PATH" ]]; then PRJ_PATH="$PWD"; fi
PRJ_PATH="`( cd -P \"$PRJ_PATH\" && pwd )`"
source "$PRJ_PATH/configs"
source "$PRJ_PATH/paths"

STOW_NAME="$PKG_NAME"_"$BLD_NAME"

cd $SRC_PATH
make install \
     install-man \
     prefix=/usr/local/stow/"$PKG_NAME"_"$BLD_NAME"

echo
cd /usr/local/stow/${STOW_NAME}/share/info && echo cd ${PWD}
mv -v dir "dir.${STOW_NAME}"

echo
cd /usr/local/stow && echo cd ${PWD}
sudo chown -R root:root "${STOW_NAME}"
sudo stow -v "${STOW_NAME}"

echo
cd /usr/local/share/info && echo cd ${PWD}

INFO_DIR_FILE=$(sudo realpath -e "dir.${STOW_NAME}")

if [[ -f dir ]]; then
  sudo sh -c 'set -x; merge-info dir "'${INFO_DIR_FILE}'" > dir'
else
  (set -x;
   sudo cp -v "${INFO_DIR_FILE}" dir)
fi
