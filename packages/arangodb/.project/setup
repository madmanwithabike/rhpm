#!/bin/bash

set -eu
set -o pipefail

sudo useradd --system --shell /usr/sbin/nologin --home /nonexistent arangodb

sudo chown -v -R arangodb:`id -gn` \
           "$PKG_NAME"_"$BLD_NAME"/var/lib/arangodb3-apps
sudo chmod 775 "$PKG_NAME"_"$BLD_NAME"/var/lib/arangodb3-apps

sudo chown -v -R arangodb:`id -gn` \
           "$PKG_NAME"_"$BLD_NAME"/var/lib/arangodb3
sudo chmod 775 "$PKG_NAME"_"$BLD_NAME"/var/lib/arangodb3

sudo chown -v -R arangodb:`id -gn` \
           "$PKG_NAME"_"$BLD_NAME"/var/log/arangodb3
sudo chmod 775 "$PKG_NAME"_"$BLD_NAME"/var/log/arangodb3

mkdir /tmp/database-dir || true
sudo chown -v arangodb:arangodb /tmp/database-dir
sudo chmod 700 /tmp/database-dir

sudo sed -i -E 'N;/^\s*#\s*End of file\s*$/i \
arangodb         soft    nofile          8192\
arangodb         hard    nofile          16384
' /etc/security/limits.conf

#perl -0777 -i -pe 's/(\n*# End of file)/\
#arangodb         soft    nofile          8192\
#arangodb         hard    nofile          16384\1/' \
#/etc/security/limits.conf

sudo sed -i -E 's/#?(DefaultLimitNOFILE)=.*/\1=16384/' \
         /etc/systemd/system.conf

sudo sysctl -w "vm.max_map_count=256000"
